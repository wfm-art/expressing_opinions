<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expressing Opinions (Personal Constructions)</title>
    
    <style>
        :root {
            /* PALETA AZUL EST√ÅNDAR (Unificada) */
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            /* Header Azul */
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* --- Modo Oscuro --- */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #bbb;
            --tab-active-text: #ffffff;
            --border-color: #444;
            --light-gray-bg: #2a2a20;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        header {
            background: var(--header-bg);
            color: white;
            padding: 20px 35px;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .control-button:hover { background: rgba(255,255,255,0.4); }

        /* --- Pesta√±as --- */
        .main-tab-nav {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 3px solid var(--dark-blue);
        }
        .main-tab-nav button {
            background-color: inherit; border: none; outline: none; cursor: pointer;
            padding: 18px 25px; transition: 0.3s; font-size: 1.1em;
            font-weight: bold; color: var(--tab-text); flex-grow: 1;
        }
        .main-tab-nav button:hover { background-color: var(--border-color); }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .main-tab-content { 
            display: none; 
            padding: 30px;
        }
        .main-tab-content.is-active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Estilos Generales --- */
        h2 { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; font-size: 1.8em; margin-top: 0; }
        h3 { color: var(--green); font-size: 1.4em; }
        .accent { color: var(--primary-blue); font-weight: bold; }
        
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .tense-box h3 { margin-top: 0; font-size: 1.6em; text-align: center; }
        
        .icon-wrapper { 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
            margin-bottom: 15px; 
            font-size: 4.5em; 
        }
        
        .button-primary {
            background-color: var(--primary-blue); color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.2s;
        }
        .button-primary:hover { background-color: var(--dark-blue); }
        .button-secondary {
            background-color: #6c757d; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-size: 0.9em;
        }

        .tts-icon {
            font-size: 1.1em;
            cursor: pointer;
            margin-left: 8px;
            display: inline-block;
            transition: transform 0.2s;
        }
        .tts-icon:hover { transform: scale(1.2); }

        /* --- Visualizador de F√≥rmula --- */
        .formula-visualizer {
            background-color: var(--light-gray-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .formula-controls { margin-bottom: 20px; }
        .formula-controls label { font-size: 1.2em; font-weight: bold; }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 10px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .formula-display { font-size: 1.3em; font-weight: bold; }
        .formula-part {
            padding: 8px 12px;
            border-radius: 5px;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            margin: 0 5px;
            display: inline-block;
        }
        .formula-part.subjunctive { background-color: #fff0f0; color: var(--red); border-color: var(--red); }
        .formula-part.infinitive { background-color: #f0fff0; color: var(--green); border-color: var(--green); }
        
        /* Video Container */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            background: #000;
            margin-top: 20px;
        }
        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; border: 0;
        }
        .video-placeholder {
            background: var(--light-gray-bg);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
        .video-placeholder p { font-style: italic; color: #555; }
        body.dark-mode .video-placeholder p { color: #bbb; }


        /* --- Tablas de Formaci√≥n --- */
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: center; }
        th { background-color: var(--light-gray-bg); }

        /* --- Pr√°ctica --- */
        .quiz-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-header h3 { margin: 0; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer;}

        .quiz-question { margin-bottom: 20px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; }
        .quiz-question p { font-size: 1.1em; margin-bottom: 10px; }
        .quiz-question button { background-color: var(--container-bg); border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 5px;}
        .quiz-question button:hover { background-color: var(--primary-blue); color: white; }

        .quiz-translation {
            display: block;
            font-size: 0.9em;
            font-style: italic;
            color: #555;
            margin: -5px 0 10px 20px;
        }
        body.dark-mode .quiz-translation { color: #bbb; }
        .quiz-translation:empty { display: none; }

        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); }
        .incorrect { color: var(--red); }
        
        .explanatory-note {
            font-size: 0.9em;
            font-style: italic;
            background-color: var(--light-gray-bg);
            border: 1px dashed var(--border-color);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .explanation-text {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
            padding: 8px;
            background: #e9ecef;
            border-radius: 4px;
        }
        body.dark-mode .explanation-text { color: #ccc; background: #333; }

        /* Historia */
        .interactive-story { background: #fdfaf6; border: 1px solid var(--yellow); padding: 20px; border-radius: 8px; font-size: 1.2em; line-height: 2; color: #333; }
        .interactive-story select { font-size: 1em; border: 2px solid #ccc; border-radius: 4px; background: #fff; padding: 2px 5px; }
        .story-explanation { display: block; font-size: 0.9em; font-style: italic; color: var(--dark-blue); margin-left: 10px; }
        body.dark-mode .interactive-story { color: #333; }
        body.dark-mode .story-explanation { color: #80bfff; }

        /* Drag & Drop */
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .dropzone.drag-over { background-color: #e9ecef; border-color: var(--primary-blue); }
        .dropzone h4 { text-align: center; margin-top: 0; }
        .draggable { background-color: var(--container-bg); border: 1px solid #ccc; padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: grab; }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary-blue); }
        #items-to-sort { margin-top: 20px; padding: 10px; background: var(--tab-bg); border-radius: 8px; min-height: 60px;}
        .drag-explanation { font-size: 0.85em; color: #555; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ccc; }
        body.dark-mode .drag-explanation { color: #bbb; }

        /* Flashcards */
        .flashcard-app { display: flex; flex-direction: column; align-items: center; }
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 25px; font-size: 1.5em; border-radius: 10px; box-sizing: border-box; white-space: normal; word-break: break-word; }
        .card-front { background: var(--container-bg); border: 2px solid var(--primary-blue); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .card-back p { margin: 10px 0 0; font-size: 0.8em; color: var(--text-color); opacity: 0.8; }
        body.dark-mode .card-back { color: var(--text-color); }
        .flashcard-nav { display: flex; justify-content: center; gap: 20px; }
        .flashcard-nav button { font-size: 1em; font-weight: bold; }
    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button id="lang-toggle" class="control-button">(EN / ES)</button>
                <button id="theme-toggle" class="control-button">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Expressing Opinions</h1>
            <p data-lang-key="header_subtitle">Personal Constructions (Parece bien/mal...)</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_metaphor">üë§=üë§ vs. üë§‚â†üë• The Rule</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formacion')" data-lang-key="tab_formation">‚úçÔ∏è Verbs & Structure</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practica')" data-lang-key="tab_practice">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_flashcards">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">The Rule: Same vs. Different Subject</h2>
                <p style="text-align:center; margin-bottom: 20px;">This rule applies to verbs like <em>parecer bien, importar, interesar</em> (similar to <em>gustar</em>).</p>
                
                <div class="comparison-grid">
                    <div class="tense-box">
                        <div class="icon-wrapper" style="color: var(--green);">
                            <span>üë§=üë§</span>
                        </div>
                        <h3 style="color: var(--green);">Infinitive</h3>
                        <p data-lang-key="metaphor_inf_desc">When the person expressing the opinion is the <strong>SAME</strong> as the person performing the action.</p>
                        <p><strong>Ex:</strong> "Me parece bien <strong>hablar</strong>." <br>(It seems good to me to speak)</p>
                    </div>
                    <div class="tense-box">
                        <div class="icon-wrapper" style="color: var(--red);">
                            <span>üë§‚â†üë•</span>
                        </div>
                        <h3 style="color: var(--red);">Subjunctive</h3>
                        <p data-lang-key="metaphor_subj_desc">When the person expressing the opinion is <strong>DIFFERENT</strong> from the person performing the action.</p>
                        <p><strong>Ex:</strong> "Me parece bien que <strong>hables</strong>." <br>(It seems good to me that you speak)</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Video Tutorial</h3>
                <div class="video-placeholder" id="video-placeholder-id">
                    <p data-lang-key="viz_video_desc">
                        <iframe src="https://drive.google.com/file/d/1Zp_seWL55p9QxQRjH15PT_KJHSoa4LWA/preview" width="640" height="400" allow="autoplay"></iframe>
                    </p>
                </div>

                <h3 data-lang-key="viz_title" style="margin-top: 30px;">Interactive Formula Visualizer</h3>
                <p data-lang-key="viz_desc">How does the sentence change? Click the "QUE" switch to find out.</p>
                
                <div class="formula-visualizer">
                    <div class="formula-controls">
                        <label data-lang-key="viz_switch_inf">Infinitive</label>
                        <label class="switch">
                            <input type="checkbox" id="que-toggle" onchange="toggleFormula()">
                            <span class="slider"></span>
                        </label>
                        <label data-lang-key="viz_switch_subj">Subjunctive (add "QUE")</label>
                    </div>
                    <div class="formula-display">
                        <span class="formula-part">A m√≠ me parece bien...</span>
                        <span class="formula-part" id="formula-que" style="display: none; background-color: #eee; border-color: #999;">que</span>
                        <span class="formula-part infinitive" id="formula-result"><strong>participar</strong>.</span>
                    </div>
                </div>
            </div>

            <div id="tab-formacion" class="main-tab-content">
                <h2 data-lang-key="form_title">How It Works (The Structure)</h2>
                
                <p data-lang-key="form_p1_desc">These verbs use Indirect Object Pronouns (me, te, le...) to say "to whom" the feeling or opinion occurs. They all follow the <em>GUSTAR</em> pattern.</p>
                
                <div class="comparison-grid">
                    <table>
                        <thead>
                            <tr>
                                <th>Clarifier (Optional)</th>
                                <th>Pronoun (Required)</th>
                                <th>Opinion Verb</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>(A m√≠)</td><td><strong>me</strong></td><td rowspan="5">parece bien / mal<br>importa<br>interesa<br>gusta / encanta<br>molesta<br>sorprende</td></tr>
                            <tr><td>(A ti)</td><td><strong>te</strong></td></tr>
                            <tr><td>(A √©l/ella)</td><td><strong>le</strong></td></tr>
                            <tr><td>(A nosotros)</td><td><strong>nos</strong></td></tr>
                            <tr><td>(A ellos/as)</td><td><strong>les</strong></td></tr>
                        </tbody>
                    </table>
                </div>
                
                <h3>Examples:</h3>
                <div class="tense-box" style="text-align: left;">
                   <ul>
                       <li>(A m√≠) <strong>Me parece bien</strong> <u>ir</u>. (Same Subject üë§=üë§)</li>
                       <li>(A m√≠) <strong>Me parece bien</strong> que t√∫ <u>vayas</u>. (Diff Subject üë§‚â†üë•)</li>
                       <li>(A nos) <strong>Nos parece mal</strong> <u>mentir</u>. (Same Subject üë§=üë§)</li>
                       <li>(A nos) <strong>Nos parece mal</strong> que ellos <u>mientan</u>. (Diff Subject üë§‚â†üë•)</li>
                   </ul>
                </div>
            </div>

            <div id="tab-practica" class="main-tab-content">
                <h2>Practice Gym</h2>
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3>Part 1: Quick Quiz</h3>
                        <button id="generate-quiz" class="refresh-btn button-secondary">New Quiz</button>
                    </div>
                    <div class="explanatory-note">Note: Audio reads infinitives to avoid spoilers.</div>
                    <div id="quiz-container"></div>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3>Part 2: Interactive Story</h3>
                        <button id="generate-story" class="refresh-btn button-secondary">New Story</button>
                    </div>
                    <p>Complete the story by choosing the correct verb form.</p>
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;">Check Story</button>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3>Part 3: Sentence Sorter</h3>
                        <button id="generate-drag" class="refresh-btn button-secondary">New Sorter</button>
                    </div>
                    <p>Drag the phrase based on the subject rule.</p>
                    <div id="items-to-sort">
                        <div id="drag-items-pool"></div>
                    </div>
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-infinitive">
                            <h4 style="color: var(--green);">Infinitive</h4>
                            <p style="font-size:0.8em; text-align:center;">(Same Subject üë§=üë§)</p>
                        </div>
                        <div class="dropzone" id="zone-subjunctive">
                            <h4 style="color: var(--red);">Subjunctive</h4>
                            <p style="font-size:0.8em; text-align:center;">(Different Subject üë§‚â†üë•)</p>
                        </div>
                    </div>
                    <button id="check-drag-btn" class="button-primary" style="margin-top: 20px;">Check Sorter</button>
                    <div id="drag-feedback" class="feedback"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2>Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="card-front"></div>
                            <div class="card-face card-back" id="card-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button onclick="prevCard()" class="button-secondary">Previous</button>
                        <button onclick="flipCard()" class="button-primary">Flip</button>
                        <button onclick="nextCard()" class="button-secondary">Next</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>

// --- DATA ---

const flashcardData = [
    { en: "It seems good to me to help.", es: "Me parece bien <strong>ayudar</strong>.", explanation: "Opinion, Same Subject üë§=üë§ -> Infinitive" },
    { en: "It seems good to me that you help.", es: "Me parece bien que <strong>ayudes</strong>.", explanation: "Opinion, Diff Subject üë§‚â†üë• -> Subjunctive" },
    { en: "It seems bad to us to lie.", es: "Nos parece mal <strong>mentir</strong>.", explanation: "Opinion, Same Subject üë§=üë§ -> Infinitive" },
    { en: "It seems bad to us that they lie.", es: "Nos parece mal que ellos <strong>mientan</strong>.", explanation: "Opinion, Diff Subject üë§‚â†üë• -> Subjunctive" },
    { en: "It bothers you (fam) to wait.", es: "Te molesta <strong>esperar</strong>.", explanation: "Feeling, Same Subject üë§=üë§ -> Infinitive" },
    { en: "It bothers you that I wait.", es: "Te molesta que yo <strong>espere</strong>.", explanation: "Feeling, Diff Subject üë§‚â†üë• -> Subjunctive" },
    { en: "It matters to him to learn.", es: "Le importa <strong>aprender</strong>.", explanation: "Opinion, Same Subject üë§=üë§ -> Infinitive" },
    { en: "It matters to him that she learns.", es: "Le importa que ella <strong>aprenda</strong>.", explanation: "Opinion, Diff Subject üë§‚â†üë• -> Subjunctive" },
    { en: "It interests me to know.", es: "Me interesa <strong>saber</strong>.", explanation: "Opinion, Same Subject -> Infinitive" },
    { en: "It interests me that you know.", es: "Me interesa que <strong>sepas</strong>.", explanation: "Opinion, Diff Subject -> Subjunctive" },
    { en: "It seems strange to travel alone.", es: "Me parece extra√±o <strong>viajar</strong> solo.", explanation: "Opinion, Same Subject -> Infinitive" },
    { en: "It seems strange that he travels alone.", es: "Me parece extra√±o que √©l <strong>viaje</strong> solo.", explanation: "Opinion, Diff Subject -> Subjunctive" }
];

const quizBank = [
    { id: "q1", question: "Me parece bien (ir) al cine.", options: ["ir", "vaya"], correct: 0, explanation: "Same subject -> Infinitive. üë§=üë§" },
    { id: "q2", question: "Me parece bien que t√∫ (ir) al cine.", options: ["ir", "vayas"], correct: 1, explanation: "Different subjects -> Subjunctive. üë§‚â†üë•" },
    { id: "q3", question: "Nos parece mal (llegar) tarde.", options: ["llegar", "lleguemos"], correct: 0, explanation: "Same subject -> Infinitive. üë§=üë§" },
    { id: "q4", question: "Nos parece mal que ellos (llegar) tarde.", options: ["llegar", "lleguen"], correct: 1, explanation: "Different subjects -> Subjunctive. üë§‚â†üë•" },
    { id: "q5", question: "Le importa (estudiar).", options: ["estudiar", "estudie"], correct: 0, explanation: "Same subject -> Infinitive. üë§=üë§" },
    { id: "q6", question: "Le importa que nosotros (estudiar).", options: ["estudiar", "estudiemos"], correct: 1, explanation: "Different subjects -> Subjunctive. üë§‚â†üë•" },
    { id: "q7", question: "Te sorprende (ver) esto.", options: ["ver", "veas"], correct: 0, explanation: "Same subject -> Infinitive. üë§=üë§" },
    { id: "q8", question: "Te sorprende que yo (ver) esto.", options: ["ver", "vea"], correct: 1, explanation: "Different subjects -> Subjunctive. üë§‚â†üë•" },
    { id: "q9", question: "Nos interesa (aprender).", options: ["aprender", "aprendamos"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q10", question: "Nos interesa que t√∫ (aprender).", options: ["aprender", "aprendas"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q11", question: "Les molesta (pagar).", options: ["pagar", "paguen"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q12", question: "Les molesta que yo no (pagar).", options: ["pagar", "pague"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q13", question: "Me parece justo (dividir) la cuenta.", options: ["dividir", "divida"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q14", question: "Me parece justo que (dividir) la cuenta.", options: ["dividir", "dividamos"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q15", question: "Te encanta (bailar).", options: ["bailar", "bailes"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q16", question: "Te encanta que yo (bailar).", options: ["bailar", "baile"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q17", question: "Le parece importante (reciclar).", options: ["reciclar", "recicle"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q18", question: "Le parece importante que la gente (reciclar).", options: ["reciclar", "recicle"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q19", question: "Nos cae mal (esperar).", options: ["esperar", "esperemos"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q20", question: "Nos cae mal que ellos nos (hacer) esperar.", options: ["hacer", "hagan"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q21", question: "Me parece extra√±o (estar) solo.", options: ["estar", "est√©"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q22", question: "Me parece extra√±o que t√∫ (estar) solo.", options: ["estar", "est√©s"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q23", question: "Les hace ilusi√≥n (viajar).", options: ["viajar", "viajen"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q24", question: "Les hace ilusi√≥n que nosotros (viajar).", options: ["viajar", "viajemos"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q25", question: "Te importa (saber) la verdad.", options: ["saber", "sepas"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q26", question: "Te importa que ella (saber) la verdad.", options: ["saber", "sepa"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q27", question: "Me parece horrible (perder) tiempo.", options: ["perder", "pierda"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q28", question: "Me parece horrible que t√∫ (perder) tiempo.", options: ["perder", "pierdas"], correct: 1, explanation: "Different subjects -> Subjunctive." },
    { id: "q29", question: "Nos gusta (comer) bien.", options: ["comer", "comamos"], correct: 0, explanation: "Same subject -> Infinitive." },
    { id: "q30", question: "Nos gusta que ellos (comer) bien.", options: ["comer", "coman"], correct: 1, explanation: "Different subjects -> Subjunctive." }
];

const storyBank = [
    {
        id: "story1",
        html: `
            <span><strong>La Fiesta:</strong><br><br></span>
            <span>A m√≠ me hace ilusi√≥n</span> 
            <select id="story1-1" data-type="infinitive"><option value="c">ir</option><option value="w">vaya</option></select>
            <span>a la fiesta. Pero a mis padres les parece mal que yo</span> 
            <select id="story1-2" data-type="subjunctive"><option value="c">vuelva</option><option value="w">volver</option></select>
            <span>tarde. A ellos les importa</span> 
            <select id="story1-3" data-type="infinitive"><option value="w">duerman</option><option value="c">dormir</option></select>
            <span>tranquilos, y les molesta que yo</span> 
            <select id="story1-4" data-type="subjunctive"><option value="w">hacer</option><option value="c">haga</option></select>
            <span>ruido.</span>
        `
    },
    {
        id: "story2",
        html: `
            <span><strong>El Proyecto Comunitario:</strong><br><br></span>
            <span>Nos parece bien</span> 
            <select id="story2-1" data-type="infinitive"><option value="w">ayudemos</option><option value="c">ayudar</option></select>
            <span>a la comunidad. Nos sorprende que el gobierno no</span> 
            <select id="story2-2" data-type="subjunctive"><option value="c">haga</option><option value="w">hacer</option></select>
            <span>m√°s. A la gente le encanta</span> 
            <select id="story2-3" data-type="infinitive"><option value="c">recibir</option><option value="w">reciba</option></select>
            <span>ayuda, y les hace ilusi√≥n que nosotros</span> 
            <select id="story2-4" data-type="subjunctive"><option value="w">estar</option><option value="c">estemos</option></select>
            <span>aqu√≠.</span>
        `
    },
    {
        id: "story3",
        html: `
            <span><strong>Compa√±eros de Piso:</strong><br><br></span>
            <span>Me molesta</span> 
            <select id="story3-1" data-type="infinitive"><option value="c">limpiar</option><option value="w">limpie</option></select>
            <span>la cocina siempre. Me parece injusto que t√∫ nunca</span> 
            <select id="story3-2" data-type="subjunctive"><option value="c">ayudes</option><option value="w">ayudar</option></select>
            <span>. Te importa mucho</span> 
            <select id="story3-3" data-type="infinitive"><option value="c">ver</option><option value="w">veas</option></select>
            <span>la televisi√≥n, pero no te importa que la casa</span> 
            <select id="story3-4" data-type="subjunctive"><option value="c">est√©</option><option value="w">estar</option></select>
            <span>sucia.</span>
        `
    },
    {
        id: "story4",
        html: `
            <span><strong>Viaje Escolar:</strong><br><br></span>
            <span>Al profesor le interesa</span> 
            <select id="story4-1" data-type="infinitive"><option value="c">visitar</option><option value="w">visite</option></select>
            <span>el museo. A los estudiantes les parece aburrido que el gu√≠a</span> 
            <select id="story4-2" data-type="subjunctive"><option value="c">hable</option><option value="w">hablar</option></select>
            <span>tanto. Les gustar√≠a</span> 
            <select id="story4-3" data-type="infinitive"><option value="c">salir</option><option value="w">salgan</option></select>
            <span>pronto, pero al profesor le parece mal que ellos no</span> 
            <select id="story4-4" data-type="subjunctive"><option value="c">presten</option><option value="w">prestar</option></select>
            <span>atenci√≥n.</span>
        `
    },
    {
        id: "story5",
        html: `
            <span><strong>Tecnolog√≠a:</strong><br><br></span>
            <span>Me parece fascinante</span> 
            <select id="story5-1" data-type="infinitive"><option value="c">usar</option><option value="w">use</option></select>
            <span>la IA. Pero me preocupa que la tecnolog√≠a</span> 
            <select id="story5-2" data-type="subjunctive"><option value="c">reemplace</option><option value="w">reemplazar</option></select>
            <span>empleos. A mi hermano le da igual</span> 
            <select id="story5-3" data-type="infinitive"><option value="c">perder</option><option value="w">pierda</option></select>
            <span>su trabajo, pero a m√≠ me importa que nosotros</span> 
            <select id="story5-4" data-type="subjunctive"><option value="c">tengamos</option><option value="w">tener</option></select>
            <span>futuro.</span>
        `
    },
    {
        id: "story6",
        html: `
            <span><strong>El Gimnasio:</strong><br><br></span>
            <span>Me hace ilusi√≥n</span> 
            <select id="story6-1" data-type="infinitive"><option value="c">empezar</option><option value="w">empiece</option></select>
            <span>el gimnasio. Pero me molesta que haya</span> 
            <select id="story6-2" data-type="subjunctive"><option value="w">haber</option><option value="c">tanta</option></select>
            <span>gente. A mi entrenador le parece bien que yo</span> 
            <select id="story6-3" data-type="subjunctive"><option value="c">levante</option><option value="w">levantar</option></select>
            <span>pesas, pero me pide que no</span> 
            <select id="story6-4" data-type="infinitive"><option value="w">corra</option><option value="c">correr</option></select>
            <span>demasiado.</span>
        `
    },
    {
        id: "story7",
        html: `
            <span><strong>La Dieta:</strong><br><br></span>
            <span>Al m√©dico le parece mal</span> 
            <select id="story7-1" data-type="infinitive"><option value="c">comer</option><option value="w">coma</option></select>
            <span>mucha az√∫car. Le importa que sus pacientes</span> 
            <select id="story7-2" data-type="subjunctive"><option value="c">tengan</option><option value="w">tener</option></select>
            <span>buena salud. A m√≠ me cuesta</span> 
            <select id="story7-3" data-type="infinitive"><option value="c">dejar</option><option value="w">deje</option></select>
            <span>los dulces, pero s√© que es mejor que yo</span> 
            <select id="story7-4" data-type="subjunctive"><option value="c">coma</option><option value="w">comer</option></select>
            <span>fruta.</span>
        `
    },
    {
        id: "story8",
        html: `
            <span><strong>El Concierto:</strong><br><br></span>
            <span>Nos encanta</span> 
            <select id="story8-1" data-type="infinitive"><option value="c">escuchar</option><option value="w">escuchemos</option></select>
            <span>m√∫sica en vivo. Nos molesta que las entradas</span> 
            <select id="story8-2" data-type="subjunctive"><option value="c">sean</option><option value="w">ser</option></select>
            <span>tan caras. A mi amigo le da igual</span> 
            <select id="story8-3" data-type="infinitive"><option value="c">pagar</option><option value="w">pague</option></select>
            <span>mucho, pero a m√≠ me importa que nosotros</span> 
            <select id="story8-4" data-type="subjunctive"><option value="c">ahorremos</option><option value="w">ahorrar</option></select>
            <span>dinero.</span>
        `
    },
    {
        id: "story9",
        html: `
            <span><strong>La Boda:</strong><br><br></span>
            <span>A mi hermana le hace ilusi√≥n</span> 
            <select id="story9-1" data-type="infinitive"><option value="c">casarse</option><option value="w">se case</option></select>
            <span>. A mis padres les parece bien que ella</span> 
            <select id="story9-2" data-type="subjunctive"><option value="c">sea</option><option value="w">ser</option></select>
            <span>feliz. A m√≠ me sorprende</span> 
            <select id="story9-3" data-type="infinitive"><option value="c">ver</option><option value="w">vea</option></select>
            <span>tantos invitados, y me molesta que</span> 
            <select id="story9-4" data-type="subjunctive"><option value="c">haya</option><option value="w">haber</option></select>
            <span>tanto ruido.</span>
        `
    },
    {
        id: "story10",
        html: `
            <span><strong>El Trabajo:</strong><br><br></span>
            <span>A mi jefe le interesa</span> 
            <select id="story10-1" data-type="infinitive"><option value="c">aumentar</option><option value="w">aumente</option></select>
            <span>las ventas. Le parece mal que nosotros</span> 
            <select id="story10-2" data-type="subjunctive"><option value="c">lleguemos</option><option value="w">llegar</option></select>
            <span>tarde. A m√≠ no me importa</span> 
            <select id="story10-3" data-type="infinitive"><option value="c">trabajar</option><option value="w">trabaje</option></select>
            <span>duro, pero me molesta que √©l no</span> 
            <select id="story10-4" data-type="subjunctive"><option value="c">agradezca</option><option value="w">agradecer</option></select>
            <span>nuestro esfuerzo.</span>
        `
    },
    {
        id: "story11",
        html: `
            <span><strong>La Pol√≠tica:</strong><br><br></span>
            <span>A muchos ciudadanos les parece importante</span> 
            <select id="story11-1" data-type="infinitive"><option value="c">votar</option><option value="w">voten</option></select>
            <span>. Les preocupa que los pol√≠ticos no</span> 
            <select id="story11-2" data-type="subjunctive"><option value="c">escuchen</option><option value="w">escuchar</option></select>
            <span>al pueblo. A m√≠ me interesa</span> 
            <select id="story11-3" data-type="infinitive"><option value="c">leer</option><option value="w">lea</option></select>
            <span>las noticias, y me sorprende que la gente</span> 
            <select id="story11-4" data-type="subjunctive"><option value="c">ignore</option><option value="w">ignorar</option></select>
            <span>los problemas.</span>
        `
    },
    {
        id: "story12",
        html: `
            <span><strong>El Medio Ambiente:</strong><br><br></span>
            <span>Nos parece urgente</span> 
            <select id="story12-1" data-type="infinitive"><option value="c">proteger</option><option value="w">protejamos</option></select>
            <span>la naturaleza. Nos molesta que las empresas</span> 
            <select id="story12-2" data-type="subjunctive"><option value="c">contaminen</option><option value="w">contaminar</option></select>
            <span>los r√≠os. A m√≠ me gusta</span> 
            <select id="story12-3" data-type="infinitive"><option value="c">reciclar</option><option value="w">recicle</option></select>
            <span>, y espero que todos</span> 
            <select id="story12-4" data-type="subjunctive"><option value="c">hagan</option><option value="w">hacer</option></select>
            <span>lo mismo.</span>
        `
    },
    {
        id: "story13",
        html: `
            <span><strong>Las Redes Sociales:</strong><br><br></span>
            <span>A los j√≥venes les encanta</span> 
            <select id="story13-1" data-type="infinitive"><option value="c">compartir</option><option value="w">compartan</option></select>
            <span>fotos. A los padres les preocupa que sus hijos</span> 
            <select id="story13-2" data-type="subjunctive"><option value="c">pasen</option><option value="w">pasar</option></select>
            <span>demasiado tiempo online. A m√≠ me parece bien</span> 
            <select id="story13-3" data-type="infinitive"><option value="c">usar</option><option value="w">use</option></select>
            <span>Instagram, pero me molesta que la gente</span> 
            <select id="story13-4" data-type="subjunctive"><option value="c">sea</option><option value="w">ser</option></select>
            <span>falsa.</span>
        `
    },
    {
        id: "story14",
        html: `
            <span><strong>La Moda:</strong><br><br></span>
            <span>A mi amiga le importa mucho</span> 
            <select id="story14-1" data-type="infinitive"><option value="c">vestir</option><option value="w">vista</option></select>
            <span>bien. Le molesta que yo</span> 
            <select id="story14-2" data-type="subjunctive"><option value="c">use</option><option value="w">usar</option></select>
            <span>ropa vieja. A m√≠ me da igual</span> 
            <select id="story14-3" data-type="infinitive"><option value="c">estar</option><option value="w">est√©</option></select>
            <span>a la moda. Prefiero que mi ropa</span> 
            <select id="story14-4" data-type="subjunctive"><option value="c">sea</option><option value="w">ser</option></select>
            <span>c√≥moda.</span>
        `
    },
    {
        id: "story15",
        html: `
            <span><strong>El Transporte P√∫blico:</strong><br><br></span>
            <span>A la gente le molesta</span> 
            <select id="story15-1" data-type="infinitive"><option value="c">esperar</option><option value="w">esperen</option></select>
            <span>el autob√∫s. Les parece mal que el servicio</span> 
            <select id="story15-2" data-type="subjunctive"><option value="c">sea</option><option value="w">ser</option></select>
            <span>lento. A m√≠ me conviene</span> 
            <select id="story15-3" data-type="infinitive"><option value="c">tomar</option><option value="w">tome</option></select>
            <span>el metro, aunque desear√≠a que</span> 
            <select id="story15-4" data-type="subjunctive"><option value="c">hubiera</option><option value="w">haber</option></select>
            <span>menos gente.</span>
        `
    },
    {
        id: "story16",
        html: `
            <span><strong>Aprender Idiomas:</strong><br><br></span>
            <span>Me interesa</span> 
            <select id="story16-1" data-type="infinitive"><option value="c">aprender</option><option value="w">aprenda</option></select>
            <span>franc√©s. A mi profesor le parece bien que yo</span> 
            <select id="story16-2" data-type="subjunctive"><option value="c">practique</option><option value="w">practicar</option></select>
            <span>todos los d√≠as. A mis amigos les sorprende</span> 
            <select id="story16-3" data-type="infinitive"><option value="c">o√≠r</option><option value="w">oigan</option></select>
            <span>mi acento. Les gusta que yo les</span> 
            <select id="story16-4" data-type="subjunctive"><option value="c">ense√±e</option><option value="w">ense√±ar</option></select>
            <span>palabras nuevas.</span>
        `
    },
    {
        id: "story17",
        html: `
            <span><strong>Las Vacaciones:</strong><br><br></span>
            <span>Nos hace ilusi√≥n</span> 
            <select id="story17-1" data-type="infinitive"><option value="c">ir</option><option value="w">vayamos</option></select>
            <span>a la playa. A mi padre le molesta que</span> 
            <select id="story17-2" data-type="subjunctive"><option value="c">llueva</option><option value="w">llover</option></select>
            <span>. A m√≠ no me importa</span> 
            <select id="story17-3" data-type="infinitive"><option value="c">quedarme</option><option value="w">me quede</option></select>
            <span>en el hotel, pero prefiero que</span> 
            <select id="story17-4" data-type="subjunctive"><option value="c">haga</option><option value="w">hacer</option></select>
            <span>sol.</span>
        `
    },
    {
        id: "story18",
        html: `
            <span><strong>El Cine:</strong><br><br></span>
            <span>Me encanta</span> 
            <select id="story18-1" data-type="infinitive"><option value="c">ver</option><option value="w">vea</option></select>
            <span>pel√≠culas de terror. A mi novia le da miedo que</span> 
            <select id="story18-2" data-type="subjunctive"><option value="c">salgan</option><option value="w">salir</option></select>
            <span>monstruos. A ella le gusta</span> 
            <select id="story18-3" data-type="infinitive"><option value="c">comer</option><option value="w">coma</option></select>
            <span>palomitas, y le molesta que yo</span> 
            <select id="story18-4" data-type="subjunctive"><option value="c">hable</option><option value="w">hablar</option></select>
            <span>durante la pel√≠cula.</span>
        `
    },
    {
        id: "story19",
        html: `
            <span><strong>El Dinero:</strong><br><br></span>
            <span>A mis padres les preocupa</span> 
            <select id="story19-1" data-type="infinitive"><option value="c">gastar</option><option value="w">gasten</option></select>
            <span>demasiado. Les parece importante que nosotros</span> 
            <select id="story19-2" data-type="subjunctive"><option value="c">ahorremos</option><option value="w">ahorrar</option></select>
            <span>. A m√≠ me gustar√≠a</span> 
            <select id="story19-3" data-type="infinitive"><option value="c">comprar</option><option value="w">compre</option></select>
            <span>un coche, pero ellos prefieren que yo</span> 
            <select id="story19-4" data-type="subjunctive"><option value="c">espere</option><option value="w">esperar</option></select>
            <span>un poco m√°s.</span>
        `
    },
    {
        id: "story20",
        html: `
            <span><strong>La Lectura:</strong><br><br></span>
            <span>Me parece fundamental</span> 
            <select id="story20-1" data-type="infinitive"><option value="c">leer</option><option value="w">lea</option></select>
            <span>libros. Me preocupa que los ni√±os no</span> 
            <select id="story20-2" data-type="subjunctive"><option value="c">lean</option><option value="w">leer</option></select>
            <span>suficiente. A los profesores les interesa</span> 
            <select id="story20-3" data-type="infinitive"><option value="c">fomentar</option><option value="w">fomenten</option></select>
            <span>la lectura, y esperan que los padres</span> 
            <select id="story20-4" data-type="subjunctive"><option value="c">ayuden</option><option value="w">ayudar</option></select>
            <span>en casa.</span>
        `
    }
];

const dragDropBank = [
    { id: 1, text: "Me parece bien <strong>comer</strong>.", type: "infinitive", exp: "Opinion, Same Subject üë§=üë§" },
    { id: 2, text: "Me parece bien que <strong>comas</strong>.", type: "subjunctive", exp: "Opinion, Diff Subject üë§‚â†üë•" },
    { id: 3, text: "Nos molesta <strong>esperar</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 4, text: "Nos molesta que <strong>esperen</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 5, text: "Le hace ilusi√≥n <strong>ir</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 6, text: "Le hace ilusi√≥n que <strong>vayas</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 7, text: "Te sorprende <strong>ganar</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 8, text: "Te sorprende que <strong>ganen</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 9, text: "Me interesa <strong>leer</strong>.", type: "infinitive", exp: "Opinion, Same Subject üë§=üë§" },
    { id: 10, text: "Me interesa que <strong>leas</strong>.", type: "subjunctive", exp: "Opinion, Diff Subject üë§‚â†üë•" },
    { id: 11, text: "Les importa <strong>ganar</strong>.", type: "infinitive", exp: "Opinion, Same Subject üë§=üë§" },
    { id: 12, text: "Les importa que <strong>ganemos</strong>.", type: "subjunctive", exp: "Opinion, Diff Subject üë§‚â†üë•" },
    { id: 13, text: "Nos parece mal <strong>gritar</strong>.", type: "infinitive", exp: "Opinion, Same Subject üë§=üë§" },
    { id: 14, text: "Nos parece mal que <strong>griten</strong>.", type: "subjunctive", exp: "Opinion, Diff Subject üë§‚â†üë•" },
    { id: 15, text: "Me encanta <strong>bailar</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 16, text: "Me encanta que <strong>bailes</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 17, text: "Te cae mal <strong>perder</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 18, text: "Te cae mal que <strong>pierda</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 19, text: "Le molesta <strong>fumar</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 20, text: "Le molesta que <strong>fumen</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 21, text: "Nos sorprende <strong>verte</strong>.", type: "infinitive", exp: "Feeling, Same Subject üë§=üë§" },
    { id: 22, text: "Nos sorprende que <strong>vengas</strong>.", type: "subjunctive", exp: "Feeling, Diff Subject üë§‚â†üë•" },
    { id: 23, text: "Les parece raro <strong>salir</strong>.", type: "infinitive", exp: "Opinion, Same Subject üë§=üë§" },
    { id: 24, text: "Les parece raro que <strong>salgas</strong>.", type: "subjunctive", exp: "Opinion, Diff Subject üë§‚â†üë•" }
];

// --- LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    let currentStoryData = {};

    // 1. TABS
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        
        if (tabId === 'tab-practica' && !document.getElementById('quiz-container').hasChildNodes()) {
            generateQuiz(); generateStory(); generateDragDrop();
        }
    }

    // 2. VISUALIZER
    window.toggleFormula = function() {
        const toggle = document.getElementById('que-toggle');
        const quePart = document.getElementById('formula-que');
        const resultPart = document.getElementById('formula-result');

        if (toggle.checked) {
            quePart.style.display = 'inline-block';
            resultPart.innerHTML = '<strong>participes</strong>.';
            resultPart.className = 'formula-part subjunctive';
        } else {
            quePart.style.display = 'none';
            resultPart.innerHTML = '<strong>participar</strong>.';
            resultPart.className = 'formula-part infinitive';
        }
    }

    // 3. QUIZ
    document.getElementById('generate-quiz').addEventListener('click', generateQuiz);

    function generateQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        const selectedQuestions = [...quizBank].sort(() => 0.5 - Math.random()).slice(0, 5);
        
        selectedQuestions.forEach((q, i) => {
            const qId = `q_${i}`;
            const tts = `<span class="tts-icon" data-tts="${q.question.replace(/\(.*\)/, '...')}">üîä</span>`;
            
            let html = `<div class="quiz-question" id="${qId}">
                <p>${i+1}. ${q.question} ${tts}</p>`;
            
            q.options.forEach((opt, idx) => {
                html += `<button onclick="checkQuiz('${qId}', ${idx === q.correct})">${opt}</button>`;
            });
            
            html += `<span class="feedback"></span>
                     <div class="explanation-text" style="display:none;">${q.explanation}</div>
                     </div>`;
            container.innerHTML += html;
        });
    }

    window.checkQuiz = function(qId, isCorrect) {
        const el = document.getElementById(qId);
        const fb = el.querySelector('.feedback');
        const exp = el.querySelector('.explanation-text');
        exp.style.display = 'block';
        if(isCorrect) {
            fb.textContent = "Correct! üëç"; fb.className = "feedback correct";
        } else {
            fb.textContent = "Try again. üòï"; fb.className = "feedback incorrect";
        }
    }

    // 4. STORY
    document.getElementById('generate-story').addEventListener('click', generateStory);
    document.getElementById('check-story-btn').addEventListener('click', checkStory);

    function generateStory() {
        currentStoryData = storyBank[Math.floor(Math.random() * storyBank.length)];
        document.getElementById('story-container').innerHTML = currentStoryData.html;
        document.querySelectorAll('.story-explanation').forEach(e=>e.remove());
    }

    function checkStory() {
        const container = document.getElementById('story-container');
        container.querySelectorAll('.story-explanation').forEach(e=>e.remove());
        
        const selects = container.querySelectorAll('select');
        selects.forEach(sel => {
            const val = sel.value;
            const type = sel.dataset.type;
            const isCorrect = val === 'c';
            
            sel.style.borderColor = isCorrect ? "var(--green)" : "var(--red)";
            
            const exp = document.createElement('span');
            exp.className = 'story-explanation';
            exp.textContent = isCorrect ? "‚úÖ" : `‚ùå (Need ${type})`;
            sel.parentNode.insertBefore(exp, sel.nextSibling);
        });
    }

    // 5. DRAG & DROP
    const dragPool = document.getElementById('drag-items-pool');
    document.getElementById('generate-drag').addEventListener('click', generateDragDrop);
    document.getElementById('check-drag-btn').addEventListener('click', checkDrag);
    
    let currentDragItems = [];

    function generateDragDrop() {
        dragPool.innerHTML = '';
        document.getElementById('drag-feedback').textContent = '';
        document.querySelectorAll('.dropzone .draggable').forEach(e => e.remove());
        document.querySelectorAll('.drag-explanation').forEach(e => e.remove());

        currentDragItems = [...dragDropBank].sort(() => 0.5 - Math.random()).slice(0, 8);
        
        currentDragItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable';
            el.draggable = true;
            // Audio Icon
            const ttsHtml = `&nbsp;<span class="tts-icon" data-tts="${item.text.replace(/<[^>]*>?/gm, '')}">üîä</span>`;
            el.innerHTML = `${item.text} ${ttsHtml}`;
            el.dataset.type = item.type;
            el.dataset.exp = item.exp;
            
            el.addEventListener('dragstart', e => e.target.classList.add('dragging'));
            el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            el.addEventListener('touchstart', touchStart, {passive: false});
            
            dragPool.appendChild(el);
        });
        
        setupDropzones();
    }

    function setupDropzones() {
        document.querySelectorAll('.dropzone').forEach(zone => {
            zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const dragging = document.querySelector('.dragging');
                if(dragging) zone.appendChild(dragging);
            });
        });
    }

    // Touch Logic
    let tDrag = null;
    function touchStart(e) {
        if(e.target.classList.contains('tts-icon')) return;
        tDrag = e.target.closest('.draggable');
        if(!tDrag) return;
        // e.preventDefault(); 
        setTimeout(() => tDrag.classList.add('dragging'), 100);
        document.addEventListener('touchmove', touchMove, {passive: false});
        document.addEventListener('touchend', touchEnd);
    }
    function touchMove(e) {
        if(!tDrag || !tDrag.classList.contains('dragging')) return;
        e.preventDefault();
        const t = e.touches[0];
        tDrag.style.position = 'fixed';
        tDrag.style.zIndex = 1000;
        tDrag.style.left = (t.clientX - tDrag.offsetWidth/2) + 'px';
        tDrag.style.top = (t.clientY - tDrag.offsetHeight/2) + 'px';
    }
    function touchEnd(e) {
        if(!tDrag) return;
        const t = e.changedTouches[0];
        tDrag.style.position = ''; tDrag.style.zIndex = ''; tDrag.style.left = ''; tDrag.style.top = '';
        tDrag.classList.remove('dragging');
        
        const elem = document.elementFromPoint(t.clientX, t.clientY);
        const zone = elem ? elem.closest('.dropzone') : null;
        if(zone) zone.appendChild(tDrag);
        
        document.removeEventListener('touchmove', touchMove);
        document.removeEventListener('touchend', touchEnd);
        tDrag = null;
    }

    function checkDrag() {
        let correct = 0;
        const zones = {
            'zone-infinitive': 'infinitive',
            'zone-subjunctive': 'subjunctive'
        };
        
        for (const [zoneId, type] of Object.entries(zones)) {
            const zone = document.getElementById(zoneId);
            zone.querySelectorAll('.draggable').forEach(item => {
                if(item.dataset.type === type) {
                    item.style.backgroundColor = '#d4edda'; correct++;
                } else {
                    item.style.backgroundColor = '#f8d7da';
                }
                if(!item.querySelector('.drag-explanation')) {
                    const ex = document.createElement('div');
                    ex.className = 'drag-explanation';
                    ex.textContent = item.dataset.exp;
                    item.appendChild(ex);
                }
            });
        }
        document.getElementById('drag-feedback').textContent = `Correct: ${correct}`;
    }

    // 6. FLASHCARDS
    let cIdx = 0;
    function loadCard() {
        const d = flashcardData[cIdx];
        const tts = `&nbsp;<span class="tts-icon" data-tts="${d.es.replace(/<[^>]*>?/gm, '')}">üîä</span>`;
        document.getElementById('card-front').innerHTML = d.en;
        document.getElementById('card-back').innerHTML = `${d.es} ${tts}<br><br><small>${d.explanation}</small>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { cIdx = (cIdx+1)%flashcardData.length; loadCard(); };
    window.prevCard = () => { cIdx = (cIdx-1+flashcardData.length)%flashcardData.length; loadCard(); };
    
    document.getElementById('flashcard').addEventListener('click', function(e) {
        if(e.target.classList.contains('tts-icon')) {
            e.stopPropagation();
            speak(e.target.dataset.tts);
        } else {
            flipCard();
        }
    });

    // Utils - Audio Premium V2
    function speak(txt) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'es-ES';
        
        const voices = window.speechSynthesis.getVoices();
        // Prefer premium voices
        const v = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('es')) || 
                  voices.find(voice => voice.name.includes('Monica') && voice.lang.includes('es')) ||
                  voices.find(voice => voice.lang.includes('es'));
        
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
    }
    
    document.body.addEventListener('click', function(e) {
        if(e.target.classList.contains('tts-icon') && !e.target.closest('#flashcard')) {
            speak(e.target.dataset.tts);
        }
    });
    
    document.getElementById('theme-toggle').onclick = () => document.body.classList.toggle('dark-mode');

    // Init
    loadCard();
});
</script>
</body>
</html>
